<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barkodlu Stok – Firebase (Gerçek Zamanlı · PWA)</title>
  <meta name="theme-color" content="#111"/>
  <style>
    :root{ --bg:#fafafa; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --accent:#111; --ok:#16a34a; --err:#dc2626 }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px;font-weight:800}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#eee;font-weight:800;cursor:pointer;text-align:center}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .section{margin:12px 0}
    .label{font-weight:700;margin-bottom:6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,input,button{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:800;cursor:pointer}
    button.ghost{background:#eee;color:var(--fg);border-color:var(--border);font-weight:700;cursor:pointer}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
    .muted{color:var(--muted)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .small{font-size:12px}
    .hidden{display:none}
    video{width:100%;max-height:300px;border:1px solid var(--border);border-radius:10px;background:#000}
    .list-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed var(--border);align-items:center}
    .list-row:last-child{border-bottom:none}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:#dcfce7;color:#065f46}
    .pill.wait{background:#fef3c7;color:#92400e}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:6px;text-align:left}
    th{background:#f8fafc;font-weight:800}
  </style>
</head>
<body>
<div class="container">
  <h1>Barkodlu Stok – Firebase (Gerçek Zamanlı · PWA)</h1>
  <div class="small muted">IN/OUT · TRANSFER · SAYIM · Kamera · Offline senkron · Firestore ile ortak veritabanı · v2.0</div>

  <div class="tabs">
    <button class="tab active" data-tab="move">Giriş/Çıkış</button>
    <button class="tab" data-tab="transfer">Transfer</button>
    <button class="tab" data-tab="count">Sayım</button>
    <button class="tab" data-tab="live">Canlı Stok</button>
  </div>

  <div id="view-move">
    <div class="section">
      <div class="label">Depo</div>
      <select id="move-location"></select>
    </div>
    <div class="section row">
      <button class="tab active" id="btn-in">⬇️ GİRİŞ</button>
      <button class="tab" id="btn-out">⬆️ ÇIKIŞ</button>
    </div>
    <div class="section">
      <div class="label">Miktar</div>
      <input id="move-qty" type="number" value="1" min="1" />
    </div>
    <div class="section">
      <div class="label">Barkod</div>
      <div class="row">
        <input id="move-barcode" placeholder="Kameradan/klavyeden barkod" />
        <button class="primary" id="move-save">Kaydet</button>
      </div>
      <div class="small muted">Kamera açıkken barkodu gösterin, alan otomatik dolar. USB/Bluetooth okuyucu varsa klavye gibi yazar.</div>
    </div>
  </div>

  <div id="view-transfer" class="hidden">
    <div class="grid-2 section">
      <div>
        <div class="label">Kaynak</div>
        <select id="from-location"></select>
      </div>
      <div>
        <div class="label">Hedef</div>
        <select id="to-location"></select>
      </div>
    </div>
    <div class="grid-2 section">
      <div>
        <div class="label">Miktar</div>
        <input id="transfer-qty" type="number" value="1" min="1" />
      </div>
      <div>
        <div class="label">Barkod</div>
        <div class="row">
          <input id="transfer-barcode" placeholder="Kameradan/klavyeden barkod" />
          <button class="primary" id="transfer-save">Transferi Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-count" class="hidden">
    <div class="section">
      <div class="label">Sayım Lokasyonu</div>
      <select id="count-location"></select>
    </div>
    <div class="grid-2 section">
      <div>
        <div class="label">Barkod Başına Miktar</div>
        <input id="count-qty" type="number" value="1" min="1" />
      </div>
      <div>
        <div class="label">Barkod</div>
        <div class="row">
          <input id="count-barcode" placeholder="Okutulacak barkod" />
          <button id="count-add" class="ghost">Ekle</button>
          <button id="count-export" class="ghost">CSV İndir</button>
        </div>
      </div>
    </div>
    <div class="card" id="count-lines-card">
      <div style="font-weight:800">Sayım Satırları <span class="muted small" id="count-lines-count">(0)</span></div>
      <div id="count-lines"></div>
    </div>
    <div class="section"><button class="primary" id="count-submit">Sayımı Kaydet</button></div>
  </div>

  <div id="view-live" class="hidden">
    <div class="section">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">Canlı Stok (Firestore)</div>
        <div class="small muted" id="live-state">bağlanıyor…</div>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Depo</th><th>Barkod</th><th>Miktar</th><th>Güncelleme</th></tr></thead>
          <tbody id="live-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <hr />

  <div class="section">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <div style="font-weight:800">Kamera Tarama</div>
      <select id="camera-devices" title="Kamera seç"></select>
      <button id="camera-start" class="ghost">Başlat</button>
      <button id="camera-stop" class="ghost">Durdur</button>
      <span id="camera-msg" class="small muted"></span>
    </div>
    <video id="preview" playsinline muted></video>
    <div class="small muted">Kamera, <strong>HTTPS</strong> veya <strong>http://localhost</strong> altında çalışır. Code128/QR desteklenir.</div>
  </div>

  <div class="section">
    <div class="row">
      <div style="font-weight:800">Son Okunan Barkodlar</div>
      <button id="scanlog-clear" class="ghost">Listeyi Temizle</button>
    </div>
    <div id="scanlog-list" class="card"></div>
  </div>

  <div class="small muted">Veriler ortak Firestore veritabanına yazılır. Offline iken yerelde birikir, internet gelince otomatik senkron olur.</div>
</div>

<!-- ZXing -->
<script>
function httpsOk(){ return location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1'; }
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
</script>
<script>
(async()=>{ if (!window.ZXing){ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js'; s.onload=()=>{}; s.onerror=()=>console.warn('ZXing yüklenemedi'); document.head.appendChild(s);} })();
</script>

<!-- Firebase (Modüler SDK) -->
<script type="module">
  // 1) *** BURAYA kendi Firebase ayarını KOPYALA ***
  // Firebase Console → Project → Web App → SDK setup and configuration
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDcw3Mpzhw8KXZ9RpCR_M7l-pCOkJ5qVtc",
    authDomain: "stok-uygulama.firebaseapp.com",
    projectId: "stok-uygulama",
    storageBucket: "stok-uygulama.firebasestorage.app",
    messagingSenderId: "742131183035",
    appId: "1:742131183035:web:6bdc4ec1cd63f9bd3e289e",
    measurementId: "G-V7JNRWCBGE"
  };

  // ========================
  //  Firebase Başlatma
  // ========================
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';
  import { getFirestore, enableIndexedDbPersistence, collection, addDoc, serverTimestamp, doc, runTransaction, onSnapshot, query, orderBy, limit, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

  const app = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);
  try{ await enableIndexedDbPersistence(db); }catch(e){ console.warn('Persistence kapalı:', e.message); }
  await signInAnonymously(auth);

  const $ = sel=>document.querySelector(sel);
  const $$ = sel=>Array.from(document.querySelectorAll(sel));
  const opt = (v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; return o; };

  // ========================
  //  Konfig / Durum
  // ========================
  const DEPOTS=[{code:'D1',name:'Depo 1'},{code:'D2',name:'Depo 2'},{code:'D3',name:'Depo 3'}];
  let activeTab='move';
  let moveMode='IN';
  let reader=null, activeDeviceId=null;
  let scanLog=[];

  function setTab(id){ activeTab=id; renderTabs(); }
  function renderTabs(){
    $$('.tabs .tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===activeTab));
    $('#view-move').classList.toggle('hidden', activeTab!=='move');
    $('#view-transfer').classList.toggle('hidden', activeTab!=='transfer');
    $('#view-count').classList.toggle('hidden', activeTab!=='count');
    $('#view-live').classList.toggle('hidden', activeTab!=='live');
  }
  function renderMoveMode(){ $('#btn-in').classList.toggle('active', moveMode==='IN'); $('#btn-out').classList.toggle('active', moveMode==='OUT'); }
  function renderDepots(sel){ sel.innerHTML=''; DEPOTS.forEach(d=> sel.appendChild(opt(d.code, `${d.name} (${d.code})`))); }

  function pushScanLog(entry){ scanLog=[entry,...scanLog].slice(0,100); renderScanLog(); }
  function renderScanLog(){ const wrap=$('#scanlog-list'); wrap.innerHTML=''; if(!scanLog.length){ wrap.innerHTML='<div class="small muted">Henüz barkod okutulmadı.</div>'; return;} scanLog.forEach(s=>{ const row=document.createElement('div'); row.className='list-row'; const left=document.createElement('div'); left.style.flex='1'; left.textContent=`${s.code} — ${s.action} ×${s.qty} ${s.extra||''}`; const right=document.createElement('div'); right.className='small muted'; right.textContent=new Date(s.ts).toLocaleTimeString(); row.appendChild(left); row.appendChild(right); wrap.appendChild(row); }); }

  // ========================
  //  Firestore Yazma / İş Kuralları
  // ========================
  function stockDoc(barcode, location){ return doc(db, 'stock_levels', `${barcode}_${location}`); }

  async function moveStock({action, barcode, qty, location}){
    if (!barcode) throw new Error('Barkod boş'); if (!qty || qty<=0) throw new Error('Miktar +');
    // 1) hareket kaydı
    await addDoc(collection(db, 'movements'), { action, barcode, qty, location, ts: serverTimestamp(), uid: auth.currentUser?.uid||null });
    // 2) stok seviyesi güncelle (transaction)
    await runTransaction(db, async (tx)=>{
      const ref = stockDoc(barcode, location);
      const snap = await tx.get(ref);
      const cur = snap.exists()? (snap.data().qty||0) : 0;
      const delta = action==='IN'? qty : -qty;
      const next = cur + delta;
      await tx.set(ref, { barcode, location, qty: next, updatedAt: serverTimestamp() }, { merge:true });
    });
  }

  async function transferStock({barcode, qty, fromLocation, toLocation}){
    if (!barcode) throw new Error('Barkod boş'); if (!qty || qty<=0) throw new Error('Miktar +'); if (fromLocation===toLocation) throw new Error('Kaynak ve hedef aynı');
    await addDoc(collection(db, 'transfers'), { barcode, qty, fromLocation, toLocation, ts: serverTimestamp(), uid: auth.currentUser?.uid||null });
    await runTransaction(db, async (tx)=>{
      const fromRef = stockDoc(barcode, fromLocation);
      const toRef   = stockDoc(barcode, toLocation);
      const fromSnap = await tx.get(fromRef); const toSnap = await tx.get(toRef);
      const fromCur = fromSnap.exists()? (fromSnap.data().qty||0) : 0;
      const toCur   = toSnap.exists()? (toSnap.data().qty||0) : 0;
      await tx.set(fromRef, { barcode, location:fromLocation, qty: fromCur - qty, updatedAt: serverTimestamp() }, { merge:true });
      await tx.set(toRef,   { barcode, location:toLocation,   qty: toCur + qty,   updatedAt: serverTimestamp() }, { merge:true });
    });
  }

  async function submitCount({location, lines}){
    if (!location) throw new Error('Lokasyon boş'); if (!Array.isArray(lines)||!lines.length) throw new Error('Satır yok');
    const countRef = await addDoc(collection(db, 'counts'), { location, ts: serverTimestamp(), uid: auth.currentUser?.uid||null });
    for (const ln of lines){ await addDoc(collection(countRef, 'lines'), { barcode: ln.barcode, qty: ln.qty }); }
    // İstersen sayımı stoğa uygula (manuel): burada her satır için stock_levels set edebilirsin.
  }

  // ========================
  //  Canlı Stok İzleme
  // ========================
  let unsubscribeLive=null;
  function startLive(){
    const tbody = $('#live-table'); tbody.innerHTML='';
    const q = query(collection(db, 'stock_levels'), orderBy('location'), orderBy('barcode'));
    unsubscribeLive = onSnapshot(q, (snap)=>{
      $('#live-state').textContent = `kayıt: ${snap.size}`;
      tbody.innerHTML='';
      snap.forEach(docu=>{
        const d = docu.data();
        const tr = document.createElement('tr');
        const tds = [d.location, d.barcode, d.qty, new Date().toLocaleTimeString()];
        tds.forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
    }, (err)=>{ $('#live-state').textContent = 'hata: '+err.message; });
  }

  // ========================
  //  Kamera
  // ========================
  async function listCameras(){ const devices = await navigator.mediaDevices.enumerateDevices(); return devices.filter(d=>d.kind==='videoinput'); }
  async function fillCameraList(){ const sel=$('#camera-devices'); sel.innerHTML=''; const cams = await listCameras(); cams.forEach(c=> sel.appendChild(opt(c.deviceId, c.label||'Kamera')) ); if (cams[0]) activeDeviceId=cams[0].deviceId; }
  async function startCamera(){ const msg=$('#camera-msg'); if (!httpsOk()){ msg.textContent='Kamera için HTTPS/localhost gerekir.'; return; } try{ if(!window.ZXing) await new Promise(r=>setTimeout(r,300)); if (!reader) reader = new ZXing.BrowserMultiFormatReader(); await fillCameraList(); const id=$('#camera-devices').value||activeDeviceId; msg.textContent='Kamera açılıyor…'; await reader.decodeFromVideoDevice(id, 'preview', debounce((res)=>{ if(res&&res.text){ if (startCamera.last===res.text && Date.now()-startCamera.lastTs<900) return; startCamera.last=res.text; startCamera.lastTs=Date.now(); const code=res.text; if (activeTab==='move'){ $('#move-barcode').value=code; onAddMove(); } else if (activeTab==='transfer'){ $('#transfer-barcode').value=code; onAddTransfer(); } else if (activeTab==='count'){ $('#count-barcode').value=code; onAddCountLine(); } } },100)); msg.textContent='Kamera aktif — barkodu gösterin'; }catch(e){ $('#camera-msg').textContent='Hata: '+e.message; } }
  function stopCamera(){ if(reader){ reader.reset(); } $('#camera-msg').textContent='Kamera durduruldu'; }

  // ========================
  //  UI Eventleri
  // ========================
  ['#move-location','#from-location','#to-location','#count-location'].forEach(sel=>{ const el=$(sel); renderDepots(el); });
  $$('.tabs .tab').forEach(b=> b.addEventListener('click', ()=>{ setTab(b.dataset.tab); if (b.dataset.tab==='live'){ startLive(); } }));
  $('#btn-in').addEventListener('click', ()=>{ moveMode='IN'; renderMoveMode(); });
  $('#btn-out').addEventListener('click', ()=>{ moveMode='OUT'; renderMoveMode(); });

  async function onAddMove(){
    const barcode=$('#move-barcode').value.trim(); const qty=Number($('#move-qty').value); const location=$('#move-location').value;
    if (!barcode||!qty||qty<=0) return alert('Barkod/Miktar kontrol edin');
    try{ await moveStock({ action: moveMode, barcode, qty, location }); pushScanLog({ code: barcode, qty, action: moveMode, ts: Date.now(), extra:`Lok: ${location}` }); $('#move-barcode').value=''; $('#move-qty').value=1; $('#move-barcode').focus(); } catch(e){ alert('Hata: '+e.message); }
  }
  async function onAddTransfer(){
    const barcode=$('#transfer-barcode').value.trim(); const qty=Number($('#transfer-qty').value); const from=$('#from-location').value; const to=$('#to-location').value;
    if (!barcode||!qty||qty<=0||from===to) return alert('Alanları kontrol edin');
    try{ await transferStock({ barcode, qty, fromLocation:from, toLocation:to }); pushScanLog({ code: barcode, qty, action: 'TRANSFER', ts: Date.now(), extra:`${from}→${to}` }); $('#transfer-barcode').value=''; $('#transfer-qty').value=1; $('#transfer-barcode').focus(); } catch(e){ alert('Hata: '+e.message); }
  }
  function onAddCountLine(){
    const barcode=$('#count-barcode').value.trim(); const qty=Number($('#count-qty').value);
    if (!barcode||!qty||qty<=0) return alert('Barkod/Miktar kontrol edin');
    const linesWrap=$('#count-lines'); const existing=Array.from(linesWrap.children).find(ch=>ch.dataset.code===barcode);
    if (existing){ const qEl=existing.querySelector('.qty'); qEl.textContent=String(Number(qEl.textContent)+qty); }
    else { const row=document.createElement('div'); row.className='row'; row.dataset.code=barcode; row.style.justifyContent='space-between'; row.style.padding='4px 0'; const l=document.createElement('div'); l.textContent=barcode; const r=document.createElement('div'); r.className='qty'; r.style.width='60px'; r.style.textAlign='right'; r.textContent=String(qty); row.appendChild(l); row.appendChild(r); linesWrap.prepend(row); }
    pushScanLog({ code: barcode, qty, action: 'COUNT', ts: Date.now(), extra:`Lok: ${$('#count-location').value}` }); $('#count-barcode').value=''; $('#count-barcode').focus(); updateCountCounter();
  }
  async function onSubmitCount(){
    const location=$('#count-location').value; const linesWrap=$('#count-lines'); const lines=Array.from(linesWrap.children).map(ch=>({ barcode: ch.dataset.code, qty: Number(ch.querySelector('.qty').textContent) }));
    if (!lines.length) return alert('En az bir satır ekleyin');
    try{ await submitCount({ location, lines }); linesWrap.innerHTML=''; updateCountCounter(); alert('Sayım kaydedildi'); } catch(e){ alert('Hata: '+e.message); }
  }
  function updateCountCounter(){ $('#count-lines-count').textContent='(' + $('#count-lines').children.length + ')'; }

  $('#move-save').addEventListener('click', onAddMove);
  $('#transfer-save').addEventListener('click', onAddTransfer);
  $('#count-add').addEventListener('click', onAddCountLine);
  $('#count-submit').addEventListener('click', onSubmitCount);
  $('#count-export').addEventListener('click', ()=>{
    const linesWrap=$('#count-lines'); const rows=Array.from(linesWrap.children).map(ch=>({ barcode: ch.dataset.code, qty: Number(ch.querySelector('.qty').textContent) })); if(!rows.length) return alert('Liste boş'); const csv=['barcode,qty', ...rows.map(r=>`${r.barcode},${r.qty}`)].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`sayim_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  $('#camera-start').addEventListener('click', startCamera);
  $('#camera-stop').addEventListener('click', stopCamera);
  $('#camera-devices').addEventListener('change', ()=>{ stopCamera(); startCamera(); });
  $('#scanlog-clear').addEventListener('click', ()=>{ scanLog=[]; renderScanLog(); });

  renderTabs(); renderMoveMode(); ['#move-location','#from-location','#to-location','#count-location'].forEach(sel=>renderDepots($(sel)));
  if (httpsOk()) startCamera();
})();
</script>
</body>
</html>
